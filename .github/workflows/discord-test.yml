name: Discord Role Mention Test
on:
  workflow_dispatch:
jobs:
  send-test-message:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Install requests
        run: pip install requests
      - name: Write test script
        run: |
          cat > test_discord_ping.py <<EOF
          import os
          import requests
          webhook = os.getenv('DISCORD_WEBHOOK_URL')
          role_id = os.getenv('ROLE_ID')
          if not webhook or not role_id:
              print('Missing webhook or role ID')
              exit(1)
          content = f'<@&{role_id}> Test message from GitHub Actions'
          payload = {
              'content': content,
              'allowed_mentions': {'roles': [role_id]}
          }
          response = requests.post(webhook, json=payload)
          print('Status:', response.status_code)
          print('Response:', response.text)
          if response.status_code != 204:
              exit(1)
          EOF
      - name: Run test script
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          ROLE_ID: ${{ secrets.ROLE_ID }}
        run: python test_discord_ping.py